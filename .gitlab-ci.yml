include:
  - template: Jobs/Dependency-Scanning.gitlab-ci.yml
  - template: Security/License-Scanning.gitlab-ci.yml
  - template: Security/SAST.gitlab-ci.yml

image: node:19.1.0

stages:
  - test
  - deploy

cache:
  key:
    files:
      - pnpm-lock.yaml
  paths:
    - .pnpm-store

.task:
  before_script:
    - npm install --global pnpm @go-task/cli
    - pnpm config set store-dir .pnpm-store
    - pnpm install

lint:
  stage: test
  only:
    - merge_request
  extends: .task
  script:
    - task lint

format:
  stage: test
  only:
    - merge_request
  extends: .task
  script:
    - task format

coverage:unit:
  stage: test
  only:
    - merge_request
    - main
  extends: .task
  script:
    - task coverage
  coverage: /All files[^|]*\|[^|]*\s+([\d\.]+)/
  artifacts:
    reports:
      junit: test-results/junit.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml

tests:e2e:
  stage: test
  only:
    - merge_request
  image: registry.gitlab.com/hmajid2301/playwright-docker:latest
  services:
    - name: docker:dind
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_HOST: tcp://docker:2375
    VITE_POCKET_BASE_URL: "http://docker:9090"
  extends: .task
  script:
    - npx playwright install
    - echo "VITE_POCKET_BASE_URL='http://docker:9090'" >> .env.test
    - task e2e_tests
  after_script:
    - cat svelte_playwright.log
  artifacts:
    when: always
    paths:
      - test-results/
    expire_in: 1 week

check:
  stage: test
  only:
    - merge_request
  extends: .task
  script:
    - task check
